import streamlit as st
from docxtpl import DocxTemplate
from io import BytesIO
import datetime

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 31 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568) ---
def thai_date(date_obj):
    months = [
        "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
        "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
    ]
    day = date_obj.day
    month = months[date_obj.month - 1]
    year = date_obj.year + 543
    return f"{day} {month} {year}"

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", page_icon="üëÆ‚Äç‚ôÇÔ∏è")
st.title("üëÆ‚Äç‚ôÇÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏° (Word)")
st.caption("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå .docx ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏ó‡πå 2 ‡∏â‡∏ö‡∏±‡∏ö")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
with st.form("arrest_form"):
    st.header("1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°")
    col1, col2 = st.columns(2)
    with col1:
        date_input = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°", datetime.date.today())
    with col2:
        arrest_time = st.text_input("‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô 21:30 ‡∏ô.)", "21:30 ‡∏ô.")
    
    arrest_location = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°", "‡πÅ‡∏¢‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÇ‡∏à‡∏ô ‡∏´‡∏°‡∏π‡πà 3 ‡∏ï.‡πÅ‡∏à‡∏á‡∏á‡∏≤‡∏° ‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã ‡∏à.‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ")
    charge = st.text_area("‡∏Ç‡πâ‡∏≠‡∏´‡∏≤", "‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏£‡∏ñ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡πÄ‡∏°‡∏≤‡∏™‡∏∏‡∏£‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô")

    st.header("2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤")
    s_col1, s_col2 = st.columns([3, 1])
    with s_col1:
        suspect_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤", "‡∏ô‡∏≤‡∏¢...")
    with s_col2:
        suspect_age = st.text_input("‡∏≠‡∏≤‡∏¢‡∏∏", "...")
    
    suspect_id = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", "x-xxxx-xxxxx-xx-x")
    suspect_address = st.text_area("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£", "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà...")

    st.header("3. ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏∏‡∏î‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏°")
    # ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Default ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡πà‡∏≠‡∏¢‡πÜ
    officer_rank = st.text_input("‡∏¢‡∏® (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö/‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á)", "‡∏£.‡∏ï.‡∏≠.")
    officer_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö/‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á)", "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏û‡∏ä‡∏£‡∏õ‡∏≤‡∏ô‡∏Å‡∏±‡∏ô")
    officer_pos = st.text_input("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö/‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á)", "‡∏£‡∏≠‡∏á ‡∏™‡∏ß(‡∏à‡∏£.)‡∏™‡∏†.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã")
    officer_phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "089-8373732")

    with st.expander("‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏¢‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô)"):
        st.subheader("‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")
        c1, c2, c3 = st.columns(3)
        recorder_rank = c1.text_input("‡∏¢‡∏® (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‡∏™.‡∏ï.‡∏ó.")
        recorder_name = c2.text_input("‡∏ä‡∏∑‡πà‡∏≠ (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‡∏Å‡∏©‡∏¥‡∏î‡∏¥‡∏® ‡∏ó‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß")
        recorder_pos = c3.text_input("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‡∏ú‡∏ö.‡∏´‡∏°‡∏π‡πà(‡∏õ.)‡∏Ø")

        st.subheader("‡∏û‡∏¢‡∏≤‡∏ô")
        c4, c5, c6 = st.columns(3)
        witness_rank = c4.text_input("‡∏¢‡∏® (‡∏û‡∏¢‡∏≤‡∏ô)", "‡∏î.‡∏ï.")
        witness_name = c5.text_input("‡∏ä‡∏∑‡πà‡∏≠ (‡∏û‡∏¢‡∏≤‡∏ô)", "‡πÄ‡∏â‡∏•‡∏¥‡∏° ‡∏™‡∏µ‡∏ó‡∏ô")
        witness_pos = c6.text_input("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏û‡∏¢‡∏≤‡∏ô)", "‡∏ú‡∏ö.‡∏´‡∏°‡∏π‡πà(‡∏õ.)‡∏Ø")

    # ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
    submitted = st.form_submit_button("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Word")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ---
if submitted:
    # 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏™‡πà Dictionary
    context = {
        'arrest_date':      thai_date(date_input),
        'arrest_time':      arrest_time,
        'arrest_location':  arrest_location,
        'charge':           charge,
        'suspect_name':     suspect_name,
        'suspect_age':      suspect_age,
        'suspect_id':       suspect_id,
        'suspect_address':  suspect_address,
        'officer_rank':     officer_rank,
        'officer_name':     officer_name,
        'officer_pos':      officer_pos,
        'officer_phone':    officer_phone,
        'recorder_rank':    recorder_rank,
        'recorder_name':    recorder_name,
        'recorder_pos':     recorder_pos,
        'witness_rank':     witness_rank,
        'witness_name':     witness_name,
        'witness_pos':      witness_pos
    }

    # 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Word ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô)
    def make_doc(template_name, context_data):
        doc = DocxTemplate(template_name)
        doc.render(context_data)
        bio = BytesIO()
        doc.save(bio)
        bio.seek(0)
        return bio

    try:
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå 22
        file_22 = make_doc("template_22.docx", context)
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå 23
        file_23 = make_doc("template_23.docx", context)

        st.success(f"‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '{suspect_name}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        col_d1, col_d2 = st.columns(2)
        with col_d1:
            st.download_button(
                label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (22)",
                data=file_22,
                file_name=f"22_‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_{suspect_name}.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            )
        with col_d2:
            st.download_button(
                label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (23)",
                data=file_23,
                file_name=f"23_‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°_{suspect_name}.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            )

    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        st.warning("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå template_22.docx ‡πÅ‡∏•‡∏∞ template_23.docx ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")